<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Campus AR Navigator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Three.js r128 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- AR.js -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threex.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
  position: fixed;
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

#arCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

#ui {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  padding: 15px;
  border-radius: 12px;
  color: white;
  width: 90%;
  max-width: 400px;
  z-index: 10;
  pointer-events: auto;
  touch-action: auto;
}

select, button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
  -webkit-appearance: none;
  appearance: none;
}

button {
  background: #00ff88;
  font-weight: bold;
  cursor: pointer;
}

button:hover {
  background: #00dd77;
}

button.stop {
  background: #ff4444;
}

button.stop:hover {
  background: #dd3333;
}

#status {
  text-align: center;
  margin-bottom: 8px;
  font-size: 30px;
}

#floorIndicator {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(0, 123, 255, 0.9);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  z-index: 5;
}

.instruction-text {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 0, 0.9);
  color: black;
  padding: 15px 20px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  z-index: 5;
  display: none;
  text-align: center;
  max-width: 80%;
}

.room-description {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.95);
  color: white;
  padding: 30px;
  border-radius: 15px;
  z-index: 100;
  display: none;
  max-width: 80%;
  box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
}

.room-description h2 {
  margin-top: 0;
  color: #00ff88;
}

.room-description button {
  margin-top: 15px;
  background: #00ff88;
}
</style>
</head>

<body>

<!-- Floor Indicator -->
<div id="floorIndicator">Floor: Not Set</div>

<!-- Instruction overlay -->
<div id="instructionOverlay" class="instruction-text"></div>

<!-- Room Description Modal -->
<div id="roomDescription" class="room-description">
  <h2 id="roomTitle"></h2>
  <p id="roomDetails"></p>
  <button onclick="closeRoomDescription()">Continue Navigation</button>
</div>

<!-- UI -->
<div id="ui">
  <div id="status">Select destination</div>
  <select id="roomSelect"></select>
  <button id="navButton" onclick="toggleNavigation()">Start Navigation</button>
</div>

<script>
// -------------------- GLOBAL STATE --------------------
let currentFloor = null;
let isNavigating = false;

// -------------------- ROOM DESCRIPTIONS --------------------
const roomDescriptions = {
  "101": {
    name: "Computer Laboratory 1",
    description: "Equipped with 40 high-performance computers for programming and software development courses. Features include dual monitors and latest development tools."
  },
  "102": {
    name: "Physics Laboratory",
    description: "State-of-the-art physics lab with modern equipment for mechanics, optics, and electronics experiments. Capacity: 30 students."
  },
  "103": {
    name: "Chemistry Laboratory",
    description: "Fully equipped chemistry lab with safety features, fume hoods, and complete apparatus for organic and inorganic chemistry experiments."
  },
  "201": {
    name: "Lecture Hall A",
    description: "Large lecture hall with 150-seat capacity, projector, sound system, and smart board for multimedia presentations."
  },
  "202": {
    name: "Faculty Office",
    description: "Faculty members' offices and consultation rooms. Office hours: Monday-Friday, 8:00 AM - 5:00 PM."
  },
  "203": {
    name: "Library Study Area",
    description: "Quiet study area with individual desks, group study rooms, and access to digital resources. Open 24/7 during exam periods."
  }
};

// -------------------- ROOMS PER FLOOR --------------------
const rooms = {
  1: ["101","102","103"],
  2: ["201","202","203"]
};

// -------------------- ROUTES (MARKER-BASED) --------------------
const routes = {
  "1-101": [
    { id: "start1", patt: "patterns/floor1.patt", text: "ðŸ“ Start at Floor 1" },
    { id: "hall1", patt: "patterns/hallway1.patt", text: "âž¡ Go straight" },
    { id: "turn1", patt: "patterns/turnleft.patt", text: "â†© Turn left" },
    { id: "room101", patt: "patterns/room101.patt", text: "âœ… Room 101 reached!", room: "101" }
  ],

  "1-102": [
    { id: "start1b", patt: "patterns/floor1.patt", text: "ðŸ“ Start at Floor 1" },
    { id: "hall2", patt: "patterns/hallway2.patt", text: "âž¡ Go straight" },
    { id: "room102", patt: "patterns/room102.patt", text: "âœ… Room 102 reached!", room: "102" }
  ],

  "1-103": [
    { id: "start1c", patt: "patterns/floor1.patt", text: "ðŸ“ Start at Floor 1" },
    { id: "hall3", patt: "patterns/hallway1.patt", text: "âž¡ Go straight" },
    { id: "turn2", patt: "patterns/turnright.patt", text: "â†ª Turn right" },
    { id: "room103", patt: "patterns/room103.patt", text: "âœ… Room 103 reached!", room: "103" }
  ],

  "2-201": [
    { id: "stairs", patt: "patterns/stairs.patt", text: "â¬† Go upstairs to Floor 2" },
    { id: "floor2start", patt: "patterns/floor2.patt", text: "ðŸ“ Floor 2 reached" },
    { id: "hall4", patt: "patterns/hallway2.patt", text: "âž¡ Go straight" },
    { id: "room201", patt: "patterns/room201.patt", text: "âœ… Room 201 reached!", room: "201" }
  ],
  
  "2-202": [
    { id: "stairs2", patt: "patterns/stairs.patt", text: "â¬† Go upstairs to Floor 2" },
    { id: "floor2start2", patt: "patterns/floor2.patt", text: "ðŸ“ Floor 2 reached" },
    { id: "turn3", patt: "patterns/turnleft.patt", text: "â†© Turn left" },
    { id: "room202", patt: "patterns/room202.patt", text: "âœ… Room 202 reached!", room: "202" }
  ],
  
  "2-203": [
    { id: "stairs3", patt: "patterns/stairs.patt", text: "â¬† Go upstairs to Floor 2" },
    { id: "floor2start3", patt: "patterns/floor2.patt", text: "ðŸ“ Floor 2 reached" },
    { id: "turn4", patt: "patterns/turnright.patt", text: "â†ª Turn right" },
    { id: "room203", patt: "patterns/room203.patt", text: "âœ… Room 203 reached!", room: "203" }
  ]
};

// -------------------- THREE.JS + AR.js SETUP --------------------
let scene, camera, renderer;
let arToolkitSource, arToolkitContext;
let currentRoute = [];
let currentStepIndex = 0;
let markerControls = [];

function initAR() {
  // Scene
  scene = new THREE.Scene();
  scene.visible = false;
  
  // Camera
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  scene.add(camera);
  
  // Renderer
  renderer = new THREE.WebGLRenderer({
    antialias: true,
    alpha: true
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.id = 'arCanvas';
  document.body.appendChild(renderer.domElement);
  
  // AR Toolkit Source (webcam)
  arToolkitSource = new THREEx.ArToolkitSource({
    sourceType: "webcam"
  });
  
  arToolkitSource.init(function onReady() {
    setTimeout(function() {
      arToolkitSource.onResizeElement();
      arToolkitSource.copyElementSizeTo(renderer.domElement);
    }, 2000);
  });
  
  // AR Toolkit Context
  arToolkitContext = new THREEx.ArToolkitContext({
    cameraParametersUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/data/data/camera_para.dat',
    detectionMode: 'mono'
  });
  
  arToolkitContext.init(function onCompleted() {
    camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
  });
  
  // Handle resize
  window.addEventListener('resize', onResize);
  
  // Start animation loop
  animate();
}

function onResize() {
  arToolkitSource.onResizeElement();
  arToolkitSource.copyElementSizeTo(renderer.domElement);
  if (arToolkitContext.arController !== null) {
    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
  }
}

function onResize() {
  arToolkitSource.onResizeElement();
  arToolkitSource.copyElementSizeTo(renderer.domElement);
  if (arToolkitContext.arController !== null) {
    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
  }
}

function animate() {
  requestAnimationFrame(animate);
  
  if (arToolkitSource.ready) {
    arToolkitContext.update(arToolkitSource.domElement);
    scene.visible = camera.visible;
  }
  
  renderer.render(scene, camera);
}

// -------------------- INIT --------------------
window.addEventListener("load", function() {
  checkFloorFromURL();
  initAR();
});

// -------------------- CHECK FLOOR FROM URL --------------------
function checkFloorFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const floor = urlParams.get('floor');
  
  if (floor) {
    currentFloor = parseInt(floor);
    document.getElementById("floorIndicator").textContent = `Floor: ${currentFloor}`;
    populateRooms(currentFloor);
  } else {
    document.getElementById("floorIndicator").textContent = "Floor: Scan QR Code";
    document.getElementById("status").textContent = "Scan floor QR code first";
    document.getElementById("navButton").disabled = true;
  }
}

function populateRooms(floor) {
  const select = document.getElementById("roomSelect");
  select.innerHTML = ''; // Clear existing options
  
  // Show ALL rooms from ALL floors
  for (const floorNum in rooms) {
    const group = document.createElement("optgroup");
    group.label = `Floor ${floorNum}`;
    rooms[floorNum].forEach(room => {
      const option = document.createElement("option");
      option.value = `${floorNum}-${room}`;
      option.textContent = `Room ${room}`;
      group.appendChild(option);
    });
    select.appendChild(group);
  }
  
  document.getElementById("status").textContent = "Select destination";
  document.getElementById("navButton").disabled = false;
}

// -------------------- TOGGLE NAVIGATION --------------------
function toggleNavigation() {
  if (isNavigating) {
    stopNavigation();
  } else {
    startNavigation();
  }
}

function startNavigation() {
  const roomKey = document.getElementById("roomSelect").value;
  if (!roomKey) return alert("Select a destination");

  isNavigating = true;
  document.getElementById("status").textContent =
    `Navigating to Room ${roomKey.split('-')[1]}`;
  
  const navButton = document.getElementById("navButton");
  navButton.textContent = "Stop Navigation";
  navButton.classList.add("stop");

  clearMarkers();
  loadRoute(roomKey);
}

function stopNavigation() {
  isNavigating = false;
  
  const navButton = document.getElementById("navButton");
  navButton.textContent = "Start Navigation";
  navButton.classList.remove("stop");
  
  document.getElementById("status").textContent = "Navigation stopped";
  
  clearMarkers();
}

// -------------------- LOAD ROUTE --------------------
function loadRoute(key) {
  const route = routes[key];
  if (!route) return alert("No route defined for this room");

  currentRoute = route;
  currentStepIndex = 0;
  
  route.forEach((step, index) => {
    // Create marker root
    const markerRoot = new THREE.Group();
    markerRoot.name = step.id;
    scene.add(markerRoot);
    
    // Create marker controls
    const markerControl = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
      type: 'pattern',
      patternUrl: step.patt,
      changeMatrixMode: 'cameraTransformMatrix'
    });
    
    // Create 3D arrow or cube indicator
    const geometry = new THREE.ConeGeometry(0.3, 0.6, 8);
    const material = new THREE.MeshBasicMaterial({ 
      color: index === 0 ? 0x00ff00 : 0xffff00,
      transparent: true,
      opacity: 0.8
    });
    const cone = new THREE.Mesh(geometry, material);
    cone.position.set(0, 0.1, 0);
    cone.rotation.x = Math.PI; // Point down
    markerRoot.add(cone);
    
    markerControl.addEventListener('markerFound', function() {
      console.log('Marker found:', step.id, 'Current step index:', currentStepIndex, 'This index:', index);
      
      // Only show instruction if this is the current step
      if (index === currentStepIndex) {
        showInstruction(step.text);
        
        // If this is the last step (destination), show room description
        if (step.room) {
          setTimeout(function() {
            showRoomDescription(step.room);
            document.getElementById("status").textContent = "ðŸŽ‰ Destination reached!";
          }, 1500);
        } else if (index < route.length - 1) {
          // Not the last step, advance to next
          setTimeout(function() {
            currentStepIndex = index + 1;
            material.color.setHex(0x00ff00);
          }, 1500);
        }
      }
    });
    
    markerControl.addEventListener('markerLost', function() {
      console.log('Marker lost:', step.id);
      // Hide instruction when marker is lost
      hideInstruction();
    });
    
    markerControls.push({ control: markerControl, root: markerRoot, mesh: cone });
  });
}

function showInstruction(text) {
  const overlay = document.getElementById('instructionOverlay');
  overlay.textContent = text;
  overlay.style.display = 'block';
}

function hideInstruction() {
  const overlay = document.getElementById('instructionOverlay');
  overlay.style.display = 'none';
}

// -------------------- ROOM DESCRIPTION --------------------
function showRoomDescription(roomNumber) {
  const roomInfo = roomDescriptions[roomNumber];
  if (!roomInfo) return;
  
  document.getElementById('roomTitle').textContent = `Room ${roomNumber}: ${roomInfo.name}`;
  document.getElementById('roomDetails').textContent = roomInfo.description;
  document.getElementById('roomDescription').style.display = 'block';
}

function closeRoomDescription() {
  document.getElementById('roomDescription').style.display = 'none';
  stopNavigation();
}

// -------------------- CLEAR OLD MARKERS --------------------
function clearMarkers() {
  markerControls.forEach(mc => {
    scene.remove(mc.root);
  });
  markerControls = [];
  currentRoute = [];
  currentStepIndex = 0;
  hideInstruction();
}
</script>

</body>
</html>
